<!DOCTYPE html>
<html>
<head>
    <% include ./partials/head.ejs %>
    <script type="text/javascript">
        $(document).ready(function () {

            var username = '<%= user %>'.trim();
            console.log('username : ' + username);

            var socket = io.connect("/profile_nsp");
            console.log("socket on profile : ", io.socket);

            socket.on('connect', function (data) {
                socket.emit('beConnect', {uname: username});
                socket.on('mongodata', function (mongodata) {
                    console.log("mongodata : " + mongodata);
                    mongodata.data.forEach(function (item, index, array) {
                        var divid = item.uuid + item.subscribe_key + item.publish_key + item.channel_name + item.email;
                        divid = divid.split('').reverse().join('').split('@').join('').split('.').join('');
                        $("#" + divid).addClass('user-online');
                    })
                });
                socket.on("online_peripheral_data", function (peripherals) {
                    console.log("be_online peripheral data : ", peripherals);
                    peripherals.forEach(function (tagid) {
                        $("#" + tagid).addClass('user-online');
                    });
                })
            })

            socket.on('beUserOnline', function (data) {
                console.log('user online event');
                var ele = data.tagid.toString();
                console.log(ele);
                $("#" + ele).addClass('user-online');
                socket.on("be_peripheral_online", function (peripheral_data) {
                    var ele = peripheral_data.tagid.toString();
                    console.log("event : peripheral offline : " + peripheral_data.peripheral_uuid);
                    $("#" + ele).addClass('user-online');
                });

                socket.on("be_peripheral_offline", function (peripheral_data) {
                    var ele = peripheral_data.tagid.toString();
                    console.log("event : peripheral offline : " + peripheral_data.peripheral_uuid);
                    $("#" + ele).removeClass('user-online');
                });

            });

            socket.on('beUserOffline', function (data) {
                console.log('user offline event');
                var ele = data.tagid.toString();
                console.log(ele);
                $("#" + ele).removeClass('user-online');

                //can't  change the link color when the gateway is offline
                //since the colour has to be changed, when the gateway will be online again
//                var ele = ele + 'url';
//                $('#' + ele).css('color', 'black');
            });

            socket.on('disconnect', function (data) {
                window.alert("Server disconnected. Please refresh the page.");
                socket.disconnect();
            })

            socket.on('eoninit', function (data) {
                console.log('json data : ' + JSON.stringify(data));
                var pn = PUBNUB.init({
                    publish_key: data.publish_key,
                    subscribe_key: data.subscribe_key
                });

//                var username = $('#username').html();
//                console.log("channel name received from server : " + data.channel_name);

//                mb_token: 'pk.eyJ1IjoiYW1pdGNoYWhhcjM4NCIsImEiOiJjaXFsdXBmenAwMDU2ZnBubnV5dG9rY241In0.fhR8Vj-CCDSioBvBNKGnUA',
//                        mb_id: 'amitchahar384.0lgk03ih',

                var urlreq_channel_name = username + "_urlreq";
                var urlresp_channel_name = username + "_urlresp";
                var url_not_recvd = true;
//                console.log('url channel name : ' + url_channel_name)
                pn.subscribe({
                    channel: urlresp_channel_name,
                    callback: url_received
                });

                function url_received(urldata) {
//                    urldata = JSON.parse(urldata);
                    clearInterval(urlreq_timer);
                    if (url_not_recvd) {
                        console.log("Received url : " + JSON.stringify(urldata));
                        var gwurlid = '#' + urldata.gwurlid;
                        var gwurl = urldata.gwurl;
                        $(gwurlid).wrap("<a target='_blank' href='" + gwurl + "'></a>");
                        $(gwurlid).css('color', 'blue');
//                        url_not_recvd = false;
                    }
                }

                var urlreq_timer = setInterval(function () {
                    pn.publish({
                        channel: urlreq_channel_name,
                        message: "url request",
                        callback: log,
                        error: retry
                    });

                    function log(e) {
                        console.log("requesting url over pubnub");
                    }

                    function retry() {
                        console.log('error occurred.');
                    }
                }, 1000);
                var map = eon.map({
                    pubnub: pn,
                    id: 'map',
                    mb_token: 'pk.eyJ1IjoiYW1pdGNoYWhhcjM4NCIsImEiOiJjaXFsdXBmenAwMDU2ZnBubnV5dG9rY241In0.fhR8Vj-CCDSioBvBNKGnUA',
                    mb_id: 'amitchahar384.0lgk03ih',
                    subscribe_key: 'data.subscribe_key',
                    channel: username,
//                    message: function (data) {
////                        console.log("data in mapview : ");
//
//                        for ( var obj in data){
////                            console.log("obj in data : " + JSON.stringify(data[obj]));
//                            map.setView(data[obj].latlng, 2);
//                            break;
//                        }
////                        map.setView(data.point_10.latlng, 2);
//                    },
                    connect: connect,
                    marker: function (latlng, data) {

                        var marker = new L.RotatedMarker(latlng, {});
                        console.log("data in marker : " + JSON.stringify(data));
                        marker.bindPopup('UUID : ' + data);
                        return marker;
                    }
                });

                function connect() {
                    console.log("connected to the pubnub eon");
                };
            })
        })
    </script>
    <style type="text/css">
        html, body {
            height: 100%;
        }

        .ui.grid {
            height: 100%;
        }

        ul {
            display: table;
            margin: auto;
            text-align: left;
        }

        .list {
            text-align: center
        }

        .list ul {
            display: inline-block;
            text-align: left;
        }

        #map {
            height: 100%;
            width: 100%;
            display: inline-block;
        }
    </style>
</head>
<body>
<div class="row" id="msg"></div>
<% include ./partials/header.ejs %>
<!--<center>-->
<!--<h2 class="ui header">-->
<!--<img src="/images/avatar/user1.png" class="ui circular image">-->
<!--<div id="username"></div>-->
<!--</h2>-->
<!--</center>-->

<div class="ui padded equal height stackable grid">
    <div class="eight wide center aligned column">
        <h3 class="ui header">No. of connected gateways : <%= connected_gateways %></h3>
        <h3 class="ui header">Connected gateways details : </h3>
        <br><br>
        <ul>
            <%
            var lastChannel = '';
            if(mongoData && mongoData[0]) {
                lastChannel = mongoData[0].channelName;

            mongoData.forEach(function (item, index, array) {
                var imgid = item.uuid + item.subscribe_key + item.publish_key + item.channel_name + item.email;
                imgid = imgid.toString().split('').reverse().join('');
                imgid = imgid.split('@').join('');
                imgid = imgid.split('.').join('');

                var urlid = imgid + 'url';

            if (index == 0) { %>

            <li><h4>Channel Name : <%= item.channelName %></h4>
                <ul>
                    <li>
                        <h4 class="ui header" style="display: inline-block;" id="<%= urlid %>">Gateway UUID : <%= item.uuid %> &nbsp;
                            <div id="<%= imgid %>" class="dot"></div>
                        </h4>
                        <div id="gw<%= item.uuid %>"></div>
                        <br>
                    </li>
                    <% }
                    else if (item.channelName == lastChannel) { %>
                    <li>
                        <h4 class="ui header" style="display: inline-block;" id="<%= urlid %>">Gateway UUID : <%= item.uuid %> &nbsp;
                            <div id="<%= imgid %>" class="dot"></div>
                        </h4>
                        <div id="gw<%= item.uuid %>"></div>
                        <br>
                    </li>
                    <% }
                    else { %>
                </ul>
            </li>
            <br>
            <% lastChannel = item.channelName; %>

            <li><h4> Channel Name : <%= item.channelName %></h4>
                <ul>
                    <li>
                        <h4 class="ui header" style="display: inline-block;" id="<%= urlid %>">Gateway UUID : <%= item.uuid %> &nbsp;
                            <div id="<%= imgid %>" class="dot"></div>
                        </h4>
                        <div id="gw<%= item.uuid %>"></div>
                        <br>
                    </li>
                    <% }
                    });
                    %>
                </ul>
            </li>
        </ul>

        <%
        }
        %>
        </ul>
    </div>
    <!--<div class="ui vertical divider"></div>-->
    <div class="eight wide column">
        <div class="ui grid">
            <div class="sixteen wide column">
                <div id='map'></div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
//    setTimeout(function () {

        function build_tagid(peripheral_data){
            var tagid = peripheral_data.peripheral_uuid + peripheral_data.channel_name + peripheral_data.gw_uuid + peripheral_data.email;
            tagid = tagid.toString().split('').reverse().join('');
            tagid = tagid.split('@').join('');
            tagid = tagid.split('.').join('');
            return tagid;
        }

        var username = '<%= user %>'.trim();
        $.ajax({
            url: 'fetch_peripherals',
            dataType: 'json',
            type: 'GET',
            data: {"email": username},
            success: function (data, textStatus, jQxhr) {
                //$('#progress_log_div').css('visibility', 'visible');
                if (textStatus == "success") {
                    console.log("data of ajax req : ", data);
                    var html_data = "<ul>";
                    var last_gw_uuid = -1;
                    data.forEach(function (item) {
                        if (last_gw_uuid == -1) {
                            last_gw_uuid = item.gw_uuid;
                        } else if (last_gw_uuid != item.gw_uuid) {
//                                var $id = '#' + last_gw_uuid;
                            html_data += "</ul>";
                            console.log("peripheral html data : " + html_data);
                            var $id = '#gw' + last_gw_uuid;
                            $($id).html(html_data);
                            html_data = "<ul>"
                            last_gw_uuid = item.gw_uuid;
                        }
                        var tagid = build_tagid(item);
                        html_data += "<li><h5>Peripheral -> " + item.peripheral_addr + "&nbsp;<div style='visibility: hidden' id=" + tagid + " class='dot'></div></h5></li>";
                    });
                    if (html_data != "<ul>") {
                        html_data += "</ul>";
                        console.log("peripheral html data : " + html_data);
                        var $id = '#gw' + last_gw_uuid;
//                        $($id).val(function (_, val) {
//                            return val + html_data;
//                        });
                        $($id).html(html_data);
                    }
                }
            },
            error: function (jqXhr, textStatus, errorThrown) {
                console.log(errorThrown);
            }
        });
//    }, 5000)
</script>

</body>
</html>
